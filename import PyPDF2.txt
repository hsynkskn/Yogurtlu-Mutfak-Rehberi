import PyPDF2
import google.generativeai as genai
import streamlit as st
from dotenv import load_dotenv
from googletrans import Translator

# API anahtarÄ±nÄ± yÃ¼kle
load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")

if not GOOGLE_API_KEY or GOOGLE_API_KEY == "your_api_key_here":
    st.error("LÃ¼tfen .env dosyasÄ±nda GOOGLE_API_KEY'i ayarlayÄ±n.")
    st.stop()

# Gemini yapÄ±landÄ±rmasÄ±
genai.configure(api_key=GOOGLE_API_KEY)
model = genai.GenerativeModel("gemini-1.5-flash")
translator = Translator()

# Sayfa yapÄ±landÄ±rmasÄ±
st.set_page_config(page_title="Mutfak AsistanÄ±", page_icon="ğŸ³")

# Dil seÃ§enekleri
languages = {
    "TÃ¼rkÃ§e TR": "tr",
    "English GB": "en",
    "FranÃ§ais FR": "fr",
    "Deutsch DE": "de",
    "EspaÃ±ol ES": "es",
    "Ğ ÑƒÑÑĞºĞ¸Ğ¹ RU": "ru"
}

# Sol Ã¼st kÃ¶ÅŸeye dil seÃ§imi
col1, col2 = st.columns([6, 4])
with col1:
    selected_lang = st.radio("ğŸŒ Dil SeÃ§imi:", options=list(languages.keys()), index=0, horizontal=True)
target_lang_code = languages[selected_lang]

# BaÅŸlÄ±k Ã§evirisi
default_title = "ğŸ‘¨ğŸ»â€ğŸ³ YoÄŸurtluyooo ! V1 ğŸ‘¨ğŸ»â€ğŸ³ \n" 
default_subheader = "Malzeme giriÅŸinize gÃ¶re yoÄŸurtlu tarifler Ã¶nerilir"
if target_lang_code != "tr":
    default_title = translator.translate(default_title, dest=target_lang_code).text
    default_subheader = translator.translate(default_subheader, dest=target_lang_code).text

st.title(default_title)
st.subheader(default_subheader)

# Ã‡ok dilli kategori seÃ§enekleri
category_translations = {
    "Ã‡orba": {
        "tr": "Ã‡orba",
        "en": "Soup",
        "fr": "Soupe",
        "de": "Suppe",
        "es": "Sopa",
        "ru": "Ğ¡ÑƒĞ¿"
    },
    "Yemek": {
        "tr": "Yemek",
        "en": "Main Dish",
        "fr": "Plat principal",
        "de": "Hauptgericht",
        "es": "Plato principal",
        "ru": "ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ±Ğ»ÑĞ´Ğ¾"
    },
    "TatlÄ±": {
        "tr": "TatlÄ±",
        "en": "Dessert",
        "fr": "Dessert",
        "de": "Nachspeise",
        "es": "Postre",
        "ru": "Ğ”ĞµÑĞµÑ€Ñ‚"
    },
    "Åefin SeÃ§imi": {
        "tr": "Åefin SeÃ§imi",
        "en": "Chef's Pick",
        "fr": "Choix du Chef",
        "de": "Chef-Auswahl",
        "es": "SelecciÃ³n del Chef",
        "ru": "Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑˆĞµÑ„-Ğ¿Ğ¾Ğ²Ğ°Ñ€Ğ°"
    }
}

# Dilde Ã§evrilmiÅŸ kategorileri al
translated_categories = [category_translations[cat][target_lang_code] for cat in category_translations]

# Kategori seÃ§im baÅŸlÄ±ÄŸÄ± Ã§evirisi
category_title = "Tarif Kategorisi"
category_prompt = "Tarif TÃ¼rÃ¼nÃ¼ SeÃ§in:"
if target_lang_code != "tr":
    category_title = translator.translate(category_title, dest=target_lang_code).text
    category_prompt = translator.translate(category_prompt, dest=target_lang_code).text

# Sol panelde kategori seÃ§imi
st.sidebar.title("ğŸ½ï¸ " + category_title)
selected_translated = st.sidebar.radio(category_prompt, translated_categories)

# SeÃ§ilen dildeki kategori adÄ±nÄ± TÃ¼rkÃ§e orijinaline Ã§evir
for original, translations in category_translations.items():
    if translations[target_lang_code] == selected_translated:
        category = original
        break

# Malzeme uyumsuzluÄŸu kontrol fonksiyonu
def is_compatible_with_category(ingredients, selected_category):
    ingredients = ingredients.lower()
    if selected_category == "TatlÄ±" and any(x in ingredients for x in ["et", "kuzu", "tavuk", "soÄŸan", "salÃ§a"]):
        return False
    if selected_category == "Ã‡orba" and any(x in ingredients for x in ["muz", "Ã§ilek", "kavun", "puding"]):
        return False
    if selected_category == "Yemek" and any(x in ingredients for x in ["muz", "Ã§ilek", "kavun", "puding"]):
        return False
    return True

# Sistem mesajÄ± (kategoriye gÃ¶re)
base_instruction = """
Sen bir ÅŸef chatbotusun. KullanÄ±cÄ±nÄ±n elindeki malzemelere gÃ¶re yemek tarifleri Ã¶neriyorsun.
Ancak unutma: sadece yoÄŸurt iÃ§eren tarifleri Ã¶nerebilirsin. YoÄŸurt olmayan tarifleri dikkate alma.
AÅŸaÄŸÄ±daki kurallara uy:
1. Ã–ncelikle TÃ¼rk mutfaÄŸÄ±ndan tarifler Ã¶ner, ancak istenirse diÄŸer mutfaklardan da Ã¶neriler sunabilirsin.
2. KullanÄ±cÄ± malzemeleri metin olarak girdiÄŸinde, bu malzemelerle yapÄ±labilecek yoÄŸurt iÃ§eren tarifleri Ã¶ner.
3. Her tarif iÃ§in malzeme listesi ve yapÄ±lÄ±ÅŸ adÄ±mlarÄ±nÄ± detaylÄ± olarak aÃ§Ä±kla.
4. EÄŸer eksik malzemeler varsa, alternatif malzemeler veya basitleÅŸtirilmiÅŸ tarifler Ã¶ner.
5. CevaplarÄ±nÄ± {dil} olarak ver.
"""

category_rules = {
    "Ã‡orba": "\nSadece yoÄŸurt ve Ã§orba iÃ§eren tarifleri Ã¶ner. 'Ã§orba' veya  'Ã‡orba ' kelimesi geÃ§meyen tarifleri dahil etme.",
    "Yemek": "\nTatlÄ± ve Ã§orba olmayan, sadece yemek kategorisindeki yoÄŸurt iÃ§eren tarifleri Ã¶ner.",
    "TatlÄ±": "\nSadece iÃ§inde 'tatlÄ±' geÃ§en yoÄŸurtlu tatlÄ± tariflerini Ã¶ner.",
    "Åefin SeÃ§imi": "\nEn iyi birkaÃ§ tarifi seÃ§ip Ã¶ner."
}

system_instruction = base_instruction + category_rules[category]
system_instruction = system_instruction.replace("{dil}", selected_lang)
if target_lang_code != "tr":
    system_instruction = translator.translate(system_instruction, dest=target_lang_code).text

# PDF iÃ§eriÄŸini oku
pdf_path = r"C:\\Users\\SLAYER\\OneDrive\\Desktop\\LLM\\Yogurt\\127743,yogurt-uygarligi-tarifler-v02pdf.pdf"
text = ""

try:
    with open(pdf_path, "rb") as file:
        pdf_reader = PyPDF2.PdfReader(file)
        for page in pdf_reader.pages:
            page_text = page.extract_text()
            if "yoÄŸurt" in page_text.lower():
                text += page_text
except Exception as e:
    st.error("PDF okunurken bir hata oluÅŸtu: " + str(e))
    st.stop()

# Mesaj geÃ§miÅŸi
if "messages" not in st.session_state:
    st.session_state.messages = []

# PDF'den ilk Ã¶neri alÄ±mÄ±
if "pdf_analyzed" not in st.session_state:
    user_message = f"AÅŸaÄŸÄ±daki PDF iÃ§eriÄŸinden yalnÄ±zca {category.lower()} tariflerini Ã¶nerir misin?\n\n{text[:3000]}"
    if target_lang_code != "tr":
        user_message = translator.translate(user_message, dest=target_lang_code).text

    gemini_messages = [
        {"role": "user", "parts": [system_instruction]},
        {"role": "model", "parts": ["AnladÄ±m, bu kurallara gÃ¶re hareket edeceÄŸim."]},
        {"role": "user", "parts": [user_message]},
    ]
    st.session_state.pdf_analyzed = True  # Bu satÄ±rÄ± eklemeyi unutma

# KullanÄ±cÄ± giriÅŸi
prompt_text = "Malzemelerinizi yazÄ±n..." if target_lang_code == "tr" else translator.translate("Malzemelerinizi yazÄ±n...", dest=target_lang_code).text

# Ortaya hizalamak iÃ§in boÅŸluklu kolonlar
center_col1, center_col2, center_col3 = st.columns([1, 18, 1])
with center_col2:
    user_input = st.chat_input(prompt_text)

if user_input:
    if not is_compatible_with_category(user_input, category):
        warning_text = f"âš ï¸ GirdiÄŸiniz malzemeler '{category}' kategorisi ile uyuÅŸmuyor. LÃ¼tfen farklÄ± bir kategori seÃ§in."
        if target_lang_code != "tr":
            warning_text = translator.translate(warning_text, dest=target_lang_code).text
        st.warning(warning_text)
    else:
        st.session_state.messages.append({"role": "user", "content": user_input})
        with st.chat_message("user"):
            st.write(user_input)

        gemini_messages = [
            {"role": "user", "parts": [system_instruction]},
            {"role": "model", "parts": ["AnladÄ±m, bu kurallara gÃ¶re hareket edeceÄŸim."]},
        ]

        for msg in st.session_state.messages:
            role = "user" if msg["role"] == "user" else "model"
            msg_content = msg["content"]
            if target_lang_code != "tr":
                msg_content = translator.translate(msg_content, dest=target_lang_code).text
            gemini_messages.append({"role": role, "parts": [msg_content]})

        with st.chat_message("assistant"):
            message_placeholder = st.empty()
            loading_msg = "Tarifler hazÄ±rlanÄ±yor..." if target_lang_code == "tr" else translator.translate("Tarifler hazÄ±rlanÄ±yor...", dest=target_lang_code).text
            message_placeholder.text(loading_msg)

            try:
                response = model.generate_content(gemini_messages)
                assistant_response = response.text
                message_placeholder.write(assistant_response)
                st.session_state.messages.append({"role": "assistant", "content": assistant_response})
            except Exception as e:
                st.error("Bir hata oluÅŸtu: " + str(e))