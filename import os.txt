import os
import PyPDF2
import google.generativeai as genai
import streamlit as st
from dotenv import load_dotenv
import asyncio
from deep_translator import GoogleTranslator

# API anahtarÄ±nÄ± yÃ¼kle
load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")

if not GOOGLE_API_KEY or GOOGLE_API_KEY == "your_api_key_here":
    st.error("LÃ¼tfen .env dosyasÄ±nda GOOGLE_API_KEY'i ayarlayÄ±n.")
    st.stop()

# Gemini yapÄ±landÄ±rmasÄ±
genai.configure(api_key=GOOGLE_API_KEY)
model = genai.GenerativeModel("gemini-1.5-flash")

# Asenkron Ã§eviri fonksiyonu
async def translate_text(text, target_lang):
    return await asyncio.to_thread(
        GoogleTranslator(source="auto", target=target_lang).translate, text
    )

# Streamlit ayarÄ±
st.set_page_config(page_title="Mutfak AsistanÄ±", page_icon="ğŸ³")

# Diller
languages = {
    "TÃ¼rkÃ§e TR": "tr",
    "English GB": "en",
    "FranÃ§ais FR": "fr",
    "Deutsch DE": "de",
    "EspaÃ±ol ES": "es",
    "Ğ ÑƒÑÑĞºĞ¸Ğ¹ RU": "ru"
}

col1, col2 = st.columns([6, 4])
with col1:
    selected_lang = st.radio("ğŸŒ Dil SeÃ§imi:", options=list(languages.keys()), index=0, horizontal=True)
target_lang_code = languages[selected_lang]

# Ã‡ok dilli baÅŸlatÄ±cÄ±
async def main():
    # BaÅŸlÄ±k
    default_title = "ğŸ‘¨ğŸ»â€ğŸ³ YoÄŸurtluyooo ! V1 ğŸ‘¨ğŸ»â€ğŸ³ \n"
    default_subheader = "Malzeme giriÅŸinize gÃ¶re yoÄŸurtlu tarifler Ã¶nerilir"

    if target_lang_code != "tr":
        default_title = await translate_text(default_title, target_lang_code)
        default_subheader = await translate_text(default_subheader, target_lang_code)

    st.title(default_title)
    st.subheader(default_subheader)

    # Kategoriler Ã§eviri sÃ¶zlÃ¼ÄŸÃ¼
    category_translations = {
        "Ã‡orba": {"tr": "Ã‡orba", "en": "Soup", "fr": "Soupe", "de": "Suppe", "es": "Sopa", "ru": "Ğ¡ÑƒĞ¿"},
        "Yemek": {"tr": "Yemek", "en": "Main Dish", "fr": "Plat principal", "de": "Hauptgericht", "es": "Plato principal", "ru": "ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ±Ğ»ÑĞ´Ğ¾"},
        "TatlÄ±": {"tr": "TatlÄ±", "en": "Dessert", "fr": "Dessert", "de": "Nachspeise", "es": "Postre", "ru": "Ğ”ĞµÑĞµÑ€Ñ‚"},
        "Åefin SeÃ§imi": {"tr": "Åefin SeÃ§imi", "en": "Chef's Pick", "fr": "Choix du Chef", "de": "Chef-Auswahl", "es": "SelecciÃ³n del Chef", "ru": "Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑˆĞµÑ„-Ğ¿Ğ¾Ğ²Ğ°Ñ€Ğ°"}
    }

    translated_categories = [category_translations[cat][target_lang_code] for cat in category_translations]

    category_title = "Tarif Kategorisi"
    category_prompt = "Tarif TÃ¼rÃ¼nÃ¼ SeÃ§in:"
    if target_lang_code != "tr":
        category_title = await translate_text(category_title, target_lang_code)
        category_prompt = await translate_text(category_prompt, target_lang_code)

    st.sidebar.title("ğŸ½ï¸ " + category_title)
    selected_translated = st.sidebar.radio(category_prompt, translated_categories)

    for original, translations in category_translations.items():
        if translations[target_lang_code] == selected_translated:
            category = original
            break

    # Malzeme uyuÅŸmazlÄ±ÄŸÄ± kontrolÃ¼
    def is_compatible_with_category(ingredients, selected_category):
        ingredients = ingredients.lower()
        if selected_category == "TatlÄ±" and any(x in ingredients for x in ["et", "kuzu", "tavuk", "soÄŸan", "salÃ§a"]):
            return False
        if selected_category in ["Ã‡orba", "Yemek"] and any(x in ingredients for x in ["muz", "Ã§ilek", "kavun", "puding"]):
            return False
        return True

    # Ana sistem mesajÄ±
    base_instruction_tr = """
    Sen bir ÅŸef chatbotusun. KullanÄ±cÄ±nÄ±n elindeki malzemelere gÃ¶re yemek tarifleri Ã¶neriyorsun.
    Ancak unutma: sadece yoÄŸurt iÃ§eren tarifleri Ã¶nerebilirsin. YoÄŸurt olmayan tarifleri dikkate alma.
    AÅŸaÄŸÄ±daki kurallara uy:
    1. Ã–ncelikle TÃ¼rk mutfaÄŸÄ±ndan tarifler Ã¶ner, ancak istenirse diÄŸer mutfaklardan da Ã¶neriler sunabilirsin.
    2. KullanÄ±cÄ± malzemeleri metin olarak girdiÄŸinde, bu malzemelerle yapÄ±labilecek yoÄŸurt iÃ§eren tarifleri Ã¶ner.
    3. Her tarif iÃ§in malzeme listesi ve yapÄ±lÄ±ÅŸ adÄ±mlarÄ±nÄ± detaylÄ± olarak aÃ§Ä±kla.
    4. EÄŸer eksik malzemeler varsa, alternatif malzemeler veya basitleÅŸtirilmiÅŸ tarifler Ã¶ner.
    5. CevaplarÄ±nÄ± {dil} olarak ver.
    """

    category_rules_tr = {
        "Ã‡orba": "Sadece yoÄŸurt ve Ã§orba iÃ§eren tarifleri Ã¶ner.",
        "Yemek": "TatlÄ± ve Ã§orba olmayan, sadece yemek kategorisindeki yoÄŸurt iÃ§eren tarifleri Ã¶ner.",
        "TatlÄ±": "Sadece iÃ§inde 'tatlÄ±' geÃ§en yoÄŸurtlu tatlÄ± tariflerini Ã¶ner.",
        "Åefin SeÃ§imi": "En iyi birkaÃ§ tarifi seÃ§ip Ã¶ner."
    }

    # SeÃ§ilen dilde sistem mesajÄ±
    full_instruction_tr = base_instruction_tr + "\n" + category_rules_tr[category]
    if target_lang_code != "tr":
        full_instruction = await translate_text(full_instruction_tr.replace("{dil}", selected_lang), target_lang_code)
    else:
        full_instruction = full_instruction_tr.replace("{dil}", selected_lang)

    # PDF iÃ§eriÄŸi
    pdf_path = r"C:\\Users\\SLAYER\\OneDrive\\Desktop\\LLM\\Yogurt\\127743,yogurt-uygarligi-tarifler-v02pdf.pdf"
    text = ""
    try:
        with open(pdf_path, "rb") as file:
            reader = PyPDF2.PdfReader(file)
            for page in reader.pages:
                content = page.extract_text()
                if "yoÄŸurt" in content.lower():
                    text += content
    except Exception as e:
        st.error("PDF okunurken hata oluÅŸtu: " + str(e))
        st.stop()

    if "messages" not in st.session_state:
        st.session_state.messages = []

    if "pdf_analyzed" not in st.session_state:
        user_message = f"AÅŸaÄŸÄ±daki PDF iÃ§eriÄŸinden yalnÄ±zca {category.lower()} tariflerini Ã¶nerir misin?\n\n{text[:3000]}"
        if target_lang_code != "tr":
            user_message = await translate_text(user_message, target_lang_code)

        gemini_messages = [
            {"role": "user", "parts": [full_instruction]},
            {"role": "model", "parts": ["AnladÄ±m, bu kurallara gÃ¶re hareket edeceÄŸim."]},
            {"role": "user", "parts": [user_message]},
        ]
        st.session_state.pdf_analyzed = True

    prompt_text = "Malzemelerinizi yazÄ±n..." if target_lang_code == "tr" else await translate_text("Malzemelerinizi yazÄ±n...", target_lang_code)

    center_col1, center_col2, center_col3 = st.columns([1, 18, 1])
    with center_col2:
        user_input = st.chat_input(prompt_text)

    if user_input:
        if not is_compatible_with_category(user_input, category):
            warning = f"âš ï¸ GirdiÄŸiniz malzemeler '{category}' kategorisi ile uyuÅŸmuyor. LÃ¼tfen farklÄ± bir kategori seÃ§in."
            if target_lang_code != "tr":
                warning = await translate_text(warning, target_lang_code)
            st.warning(warning)
        else:
            st.session_state.messages.append({"role": "user", "content": user_input})
            with st.chat_message("user"):
                st.write(user_input)

            gemini_messages = [
                {"role": "user", "parts": [full_instruction]},
                {"role": "model", "parts": ["AnladÄ±m, bu kurallara gÃ¶re hareket edeceÄŸim."]},
            ]
            for msg in st.session_state.messages:
                content = msg["content"]
                if target_lang_code != "tr":
                    content = await translate_text(content, target_lang_code)
                gemini_messages.append({"role": msg["role"], "parts": [content]})

            with st.chat_message("assistant"):
                message_placeholder = st.empty()
                loading = "Tarifler hazÄ±rlanÄ±yor..." if target_lang_code == "tr" else await translate_text("Tarifler hazÄ±rlanÄ±yor...", target_lang_code)
                message_placeholder.text(loading)

                try:
                    response = model.generate_content(gemini_messages)
                    reply = response.text
                    message_placeholder.write(reply)
                    st.session_state.messages.append({"role": "assistant", "content": reply})
                except Exception as e:
                    st.error("Bir hata oluÅŸtu: " + str(e))

# BaÅŸlat
if __name__ == "__main__":
    asyncio.run(main())